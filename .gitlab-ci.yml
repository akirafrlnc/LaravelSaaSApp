image: postgres:16  # Use PostgreSQL image directly

stages:
  - test

services:
  - name: postgres:16
    alias: db  # Ensures GitLab recognizes "db" as the hostname

variables:
  POSTGRES_DB: test_db
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password
  DB_HOST: db  # This must match the service alias

test_connection:
  stage: test
  script:
    - echo "Checking PostgreSQL Connection..."
    - apt-get update && apt-get install -y postgresql-client
    - until PGPASSWORD=$POSTGRES_PASSWORD psql -h "$DB_HOST" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c '\q'; do
        echo "PostgreSQL is unavailable - sleeping";
        sleep 3;
      done
    - echo "âœ… PostgreSQL is available!"
